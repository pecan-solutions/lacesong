<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="clr-namespace:Lacesong.Avalonia.ViewModels"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="Lacesong.Avalonia.Views.BrowseModsView"
             x:DataType="vm:BrowseModsViewModel">

    <Grid RowDefinitions="Auto,Auto,*">
        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,12">
            <TextBlock Text="Browse Mods" Classes="h1" Margin="0,0,0,8"/>
            <TextBlock Text="Discover and install new mods from the community." Classes="h3"/>
        </StackPanel>

        <!-- Toolbar -->
        <Border Grid.Row="1" Classes="card" Padding="16" Margin="0,0,0,16">
            <StackPanel Orientation="Horizontal" Spacing="12">
                <TextBox Text="{Binding SearchText, Mode=TwoWay}" Watermark="Search..." Width="300"/>
                <ComboBox ItemsSource="{Binding Categories}" SelectedItem="{Binding SelectedCategory, Mode=TwoWay}" Width="200"/>
                <ComboBox ItemsSource="{Binding SortOptions}" SelectedItem="{Binding SelectedSortOption, Mode=TwoWay}" Width="150"/>
                <Button Content="Search" Command="{Binding LoadModsCommand}" Classes="primary"/>
            </StackPanel>
        </Border>

        <!-- Mod List and Detail Panel -->
        <Grid Grid.Row="2" ColumnDefinitions="5*,3*" RowDefinitions="*,Auto">
            <!-- Left: Mod List -->
            <Border Grid.Column="0" Grid.Row="0" Classes="card" Padding="0" Margin="0,0,12,0">
                <ListBox ItemsSource="{Binding Mods}" SelectedItem="{Binding SelectedMod, Mode=TwoWay}" Background="Transparent" BorderThickness="0">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Grid ColumnDefinitions="48,*" Margin="8" RowDefinitions="Auto,Auto,Auto">
                                <!-- Icon -->
                                <Border Grid.Column="0" Grid.RowSpan="3" Width="48" Height="48" CornerRadius="4" ClipToBounds="True" Margin="0,0,12,0" VerticalAlignment="Top">
                                    <Image Source="{Binding Icon}" Stretch="UniformToFill" IsVisible="{Binding Icon, Converter={StaticResource ObjectToBooleanConverter}}"/>
                                </Border>
                                
                                <!-- Name -->
                                <TextBlock Grid.Column="1" Grid.Row="0" Text="{Binding Name}" Classes="h4" TextWrapping="Wrap" Margin="0,0,0,4"/>
                                
                                <!-- Author and Date -->
                                <StackPanel Grid.Column="1" Grid.Row="1" Orientation="Horizontal" Spacing="8" Margin="0,0,0,4">
                                    <TextBlock Text="{Binding Author, StringFormat='by {0}'}" Classes="smallFaded"/>
                                    <TextBlock Text="•" Classes="smallFaded"/>
                                    <TextBlock Text="{Binding LastUpdated, Converter={StaticResource RelativeTimeConverter}}" Classes="smallFaded"/>
                                </StackPanel>
                                
                                <!-- Stats -->
                                <StackPanel Grid.Column="1" Grid.Row="2" Orientation="Horizontal" Spacing="12">
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="★" Classes="smallFaded"/>
                                        <TextBlock Text="{Binding Rating, StringFormat='{}{0:F1}'}" Classes="smallFaded"/>
                                    </StackPanel>
                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                        <TextBlock Text="↓" Classes="smallFaded"/>
                                        <TextBlock Text="{Binding DownloadCount}" Classes="smallFaded"/>
                                    </StackPanel>
                                </StackPanel>
                            </Grid>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Border>

            <!-- Right: Detail Panel -->
            <Border Grid.Column="1" Grid.Row="0" Classes="card" Padding="24" IsVisible="{Binding SelectedMod, Converter={StaticResource ObjectToBooleanConverter}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Spacing="16">
                        <!-- Large Icon -->
                        <Border Width="128" Height="128" CornerRadius="8" ClipToBounds="True" HorizontalAlignment="Left">
                            <Image Source="{Binding SelectedMod.Icon}" Stretch="UniformToFill" IsVisible="{Binding SelectedMod.Icon, Converter={StaticResource ObjectToBooleanConverter}}"/>
                        </Border>

                        <!-- Name -->
                        <TextBlock Text="{Binding SelectedMod.Name}" Classes="h2"/>

                        <!-- Author -->
                        <TextBlock Classes="h4">
                            <Run Text="by"/>
                            <Run Text="{Binding SelectedMod.Author}"/>
                        </TextBlock>

                        <!-- Stats -->
                        <Grid ColumnDefinitions="Auto,*,Auto,*" RowDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="12" RowSpacing="8">
                            <TextBlock Grid.Column="0" Grid.Row="0" Text="Rating:" Classes="small" FontWeight="Bold"/>
                            <TextBlock Grid.Column="1" Grid.Row="0" Classes="small">
                                <Run Text="★"/>
                                <Run Text="{Binding SelectedMod.Rating, StringFormat='{}{0:F1}'}"/>
                            </TextBlock>

                            <TextBlock Grid.Column="0" Grid.Row="1" Text="Downloads:" Classes="small" FontWeight="Bold"/>
                            <TextBlock Grid.Column="1" Grid.Row="1" Text="{Binding SelectedMod.DownloadCount}" Classes="small"/>

                            <TextBlock Grid.Column="0" Grid.Row="2" Text="Last Updated:" Classes="small" FontWeight="Bold"/>
                            <TextBlock Grid.Column="1" Grid.Row="2" Text="{Binding SelectedMod.LastUpdated, Converter={StaticResource RelativeTimeConverter}}" Classes="small"/>

                            <TextBlock Grid.Column="0" Grid.Row="3" Text="Category:" Classes="small" FontWeight="Bold"/>
                            <TextBlock Grid.Column="1" Grid.Row="3" Text="{Binding SelectedMod.Category}" Classes="small"/>
                        </Grid>

                        <!-- Version -->
                        <StackPanel Spacing="4">
                            <TextBlock Text="Latest Version:" Classes="small" FontWeight="Bold"/>
                            <TextBlock Text="{Binding SelectedMod.LatestVersion}" Classes="small"/>
                        </StackPanel>

                        <!-- Description -->
                        <StackPanel Spacing="8">
                            <TextBlock Text="Description:" Classes="h4"/>
                            <TextBlock Text="{Binding SelectedMod.Description}" TextWrapping="Wrap" Classes="small"/>
                        </StackPanel>

                        <!-- Install Button -->
                        <Grid>
                            <ProgressBar Minimum="0" Maximum="1" Height="4" VerticalAlignment="Top" Value="{Binding InstallProgress}">
                                <ProgressBar.IsVisible>
                                    <MultiBinding Converter="{StaticResource IdMatchConverter}">
                                        <Binding Path="SelectedMod.Id"/>
                                        <Binding Path="InstallingModId"/>
                                    </MultiBinding>
                                </ProgressBar.IsVisible>
                            </ProgressBar>
                            <Button Content="Install Mod" HorizontalAlignment="Stretch"
                                    Command="{Binding InstallModCommand}"
                                    CommandParameter="{Binding SelectedMod}"
                                    Classes="primary" Padding="16,12" Margin="0,4,0,0">
                                <Button.IsEnabled>
                                    <MultiBinding Converter="{StaticResource IdMatchConverter}">
                                        <Binding Path="SelectedMod.Id"/>
                                        <Binding Path="InstallingModId"/>
                                    </MultiBinding>
                                </Button.IsEnabled>
                            </Button>
                        </Grid>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- Pagination -->
            <StackPanel Grid.Column="0" Grid.ColumnSpan="2" Grid.Row="1" Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right" Margin="0,12,0,0">
                <Button Content="Previous" Command="{Binding PreviousPageCommand}" IsEnabled="{Binding CanGoToPreviousPage}"/>
                <TextBlock VerticalAlignment="Center">
                    <Run Text="{Binding CurrentPage}"/>
                    <Run Text="/"/>
                    <Run Text="{Binding TotalPages}"/>
                </TextBlock>
                <Button Content="Next" Command="{Binding NextPageCommand}" IsEnabled="{Binding CanGoToNextPage}"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>
