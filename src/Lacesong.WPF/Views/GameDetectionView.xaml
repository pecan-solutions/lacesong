<ui:UiPage x:Class="Lacesong.WPF.Views.GameDetectionView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.openxmlformats.org/expression/blend/2008" 
             xmlns:vm="clr-namespace:Lacesong.WPF.ViewModels"
             xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="800"
             d:DataContext="{d:DesignInstance vm:GameDetectionViewModel}">


    <Grid Margin="42">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,24">
            <TextBlock Text="Game Detection" Style="{StaticResource TitleTextBlockStyle}" Margin="0,0,0,8"/>
            <TextBlock Text="Let's find your Silksong installation. You can detect automatically or browse for the game folder." 
                       Style="{StaticResource SubtitleTextBlockStyle}"/>
        </StackPanel>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="20"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Detection Panel -->
            <ui:Card Grid.Column="0" Padding="24">
                <StackPanel>
                    <TextBlock Text="Automatic Detection" Style="{StaticResource SectionHeaderTextBlockStyle}" Margin="0,0,0,16"/>
                    
                    <TextBlock Text="{Binding DetectionStatus}" Style="{StaticResource BodyTextBlockStyle}"
                               TextWrapping="Wrap" Margin="0,0,0,20"/>
                    
                    <ui:Button Content="Detect Games" Command="{Binding DetectGamesCommand}" 
                               Appearance="Primary" Icon="Search24"
                               IsEnabled="{Binding IsDetecting, Converter={StaticResource InverseBooleanConverter}}"
                               Margin="0,0,0,20"/>
                    
                    <TextBlock Text="Lacesong will scan for Silksong in:" 
                               Style="{StaticResource SmallFadedTextBlockStyle}"
                               TextWrapping="Wrap" Margin="0,0,0,8"/>
                    
                    <TextBlock Text="• Steam Library" Style="{StaticResource SmallFadedTextBlockStyle}" Margin="16,0,0,4"/>
                    <TextBlock Text="• Epic Games Store" Style="{StaticResource SmallFadedTextBlockStyle}" Margin="16,0,0,4"/>
                    <TextBlock Text="• GOG Galaxy" Style="{StaticResource SmallFadedTextBlockStyle}" Margin="16,0,0,4"/>
                    <TextBlock Text="• Common installation paths" Style="{StaticResource SmallFadedTextBlockStyle}" Margin="16,0,0,0"/>
                </StackPanel>
            </ui:Card>

            <!-- Manual Selection Panel -->
            <ui:Card Grid.Column="2" Padding="24">
                <StackPanel>
                    <TextBlock Text="Manual Selection" Style="{StaticResource SectionHeaderTextBlockStyle}" Margin="0,0,0,16"/>
                    
                    <TextBlock Text="If automatic detection fails, you can point Lacesong to your game folder directly." 
                               Style="{StaticResource BodyTextBlockStyle}"
                               TextWrapping="Wrap" Margin="0,0,0,20"/>
                    
                    <ui:Button Content="Browse for Game" Command="{Binding BrowseForGameCommand}" 
                               Appearance="Secondary" Icon="FolderOpen24" Margin="0,0,0,20"/>
                    
                    <TextBlock Text="Select the folder containing:" 
                               Style="{StaticResource SmallFadedTextBlockStyle}"
                               TextWrapping="Wrap" Margin="0,0,0,8"/>
                    
                    <TextBlock Text="Hollow Knight Silksong.exe" Style="{StaticResource MonospaceTextBlockStyle}" Margin="16,0,0,0"/>
                </StackPanel>
            </ui:Card>
        </Grid>

        <!-- Detected Games -->
        <ui:Card Grid.Row="2" Padding="24" Margin="0,24,0,0" 
                 Visibility="{Binding DetectedGames.Count, Converter={StaticResource CountToVisibilityConverter}}">
            <StackPanel>
                <TextBlock Text="Detected Games" Style="{StaticResource SectionHeaderTextBlockStyle}" Margin="0,0,0,16"/>
                
                <ListView ItemsSource="{Binding DetectedGames}" SelectedItem="{Binding SelectedGame}"
                          Background="Transparent" BorderThickness="0"
                          ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                            <Setter Property="Focusable" Value="False"/>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <ui:CardAction Padding="12" Margin="0,0,0,8">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{Binding Name}" Style="{StaticResource BodyStrongTextBlockStyle}"/>
                                        <TextBlock Text="{Binding InstallPath}" Style="{StaticResource SmallFadedTextBlockStyle}"
                                                   TextWrapping="Wrap" Margin="0,4,0,4"/>
                                        <TextBlock Text="{Binding DetectedBy, StringFormat='Detected via: {0}'}" 
                                                   Style="{StaticResource SmallFadedTextBlockStyle}"/>
                                    </StackPanel>
                                    
                                    <ui:Button Grid.Column="1" Content="Select" 
                                               Command="{Binding DataContext.SelectGameCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                               CommandParameter="{Binding}"
                                               Appearance="Primary"
                                               VerticalAlignment="Center"/>
                                </Grid>
                            </ui:CardAction>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
                
                <ui:Button Content="Continue" Command="{Binding ProceedToNextCommand}" 
                           Appearance="Primary"
                           HorizontalAlignment="Right" Margin="0,16,0,0"
                           IsEnabled="{Binding CanProceed}"/>
            </StackPanel>
        </ui:Card>
    </Grid>
</ui:UiPage>
